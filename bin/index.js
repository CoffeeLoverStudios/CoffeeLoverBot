// Generated by CoffeeScript 1.12.7
(function() {
  var Discord, DiscordAPIEnpoint, Express, app, client, request, server;

  Discord = require('discord.js');

  Express = require('express');

  request = require('request');

  DiscordAPIEnpoint = 'https://discordapp.com/api/v6';

  if (process.env.BOT_TOKEN === void 0 || process.env.BOT_CLIENT_ID === void 0 || process.env.BOT_CLIENT_SECRET === void 0) {
    console.log('No token specified!');
    return;
  }

  app = new Express;

  app.get('/', function(req, res) {
    return res.send('Hello from the other siiidddeee');
  });

  app.get('/discord_redirect', function(req, res) {
    var data, headers, r;
    console.log('Code: %s', req.query.code);
    console.log('Guild: %s', req.query.guild_id);
    data = {
      'client_id': process.env.BOT_CLIENT_ID,
      'client_secret': process.env.BOT_CLIENT_SECRET,
      'redirect_uri': './discord_redirect_success',
      'grant_type': 'authorization_code',
      'code': req.query.code
    };
    headers = {
      'Content-Type': 'application/x-www-form-urlencoded'
    };
    r = request.post(DiscordAPIEnpoint + '/oauth2/token', data, headers);
    r.raise_for_status();
    return res.send('Adding bot... \n\n\n(JSON: ' + r.json() + ')');
  });

  app.get('/discord_redirect_success', function(req, res) {
    return res.send('Added bot to guild');
  });

  client = new Discord.Client;

  client.on('ready', function() {
    return console.log('CoffeeBot started');
  });

  client.on('message', function(message) {
    if (message.content === 'bot?') {
      return message.channel.send('YOU WHAT?!');
    } else if (message.content.startsWith('ping')) {
      return message.channel.send('pong');
    }
  });

  client.on('guildMemberAdd', function(member) {
    var channel;
    channel = member.guild.channels.find('name', 'member-log');
    if (!channel) {
      return;
    }
    return channel.send('Welcome, *${member}*');
  });

  client.login('MzY0MzY3Mzk5NTM4OTE3Mzc3.DLPK-g.QlM7fZ1ofLh3liv_0E-16baovHw');

  server = app.listen(process.env.port || 3000, function() {
    var host, port;
    host = server.address().address;
    port = server.address().port;
    return console.log('Listening at \'%s:%s\'', host, port);
  });

}).call(this);
